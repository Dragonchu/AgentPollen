services:
  # Caddy reverse proxy
  caddy:
    image: caddy:2-alpine
    container_name: battle-royale-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - battle-royale
    depends_on:
      - server
      - web

  # Game server (WebSocket)
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: battle-royale-server
    restart: unless-stopped
    environment:
      - PORT=3001
      - AGENT_COUNT=${AGENT_COUNT:-10}
      - TICK_INTERVAL=${TICK_INTERVAL:-1000}
      - CORS_ORIGIN=*
      - AI_ENGINE=${AI_ENGINE:-rule-based}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - DEEPSEEK_MODEL=${DEEPSEEK_MODEL:-deepseek-chat}
      - DEEPSEEK_MAX_CONCURRENCY=${DEEPSEEK_MAX_CONCURRENCY:-10}
      - THINKING_STORAGE=${THINKING_STORAGE:-memory}
    networks:
      - battle-royale
    # Uncomment to expose directly for debugging
    # ports:
    #   - "3001:3001"

  # Next.js frontend
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        # Build-time env var: baked into Next.js bundles during compilation
        - NEXT_PUBLIC_SERVER_URL=/api/game
    container_name: battle-royale-web
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # Runtime env var: used for server-side rendering
      # Both build-time and runtime values are needed for Next.js
      - NEXT_PUBLIC_SERVER_URL=/api/game
    networks:
      - battle-royale
    # Uncomment to expose directly for debugging
    # ports:
    #   - "3000:3000"

networks:
  battle-royale:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
